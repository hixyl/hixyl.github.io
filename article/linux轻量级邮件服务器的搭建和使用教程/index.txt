3:I[9275,[],""]
5:I[1343,[],""]
6:I[4080,["185","static/chunks/app/layout-950680b5068c0831.js"],""]
7:I[4266,["185","static/chunks/app/layout-950680b5068c0831.js"],"default"]
4:["id","linux%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%90%AD%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B","d"]
0:["bbFeRMIduFcZud7BNs8NQ",[[["",{"children":["article",{"children":[["id","linux%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%90%AD%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B","d"],{"children":["__PAGE__?{\"id\":\"linux轻量级邮件服务器的搭建和使用教程\"}",{}]}]}]},"$undefined","$undefined",true],["",{"children":["article",{"children":[["id","linux%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%90%AD%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B","d"],{"children":["__PAGE__",{},[["$L1","$L2"],null],null]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","article","children","$4","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/99f6a99e5e57ec87.css","precedence":"next","crossOrigin":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/_next/static/css/d0df4e9d9cd28850.css","precedence":"next","crossOrigin":"$undefined"}],["$","link","2",{"rel":"stylesheet","href":"/_next/static/css/c033a265c4b6e7f8.css","precedence":"next","crossOrigin":"$undefined"}],["$","link","3",{"rel":"stylesheet","href":"/_next/static/css/81abeb1d965206f7.css","precedence":"next","crossOrigin":"$undefined"}],["$","link","4",{"rel":"stylesheet","href":"/_next/static/css/a46a6036119d7d12.css","precedence":"next","crossOrigin":"$undefined"}],["$","link","5",{"rel":"stylesheet","href":"/_next/static/css/51cbc18a5b192d8f.css","precedence":"next","crossOrigin":"$undefined"}]]}],null]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","article","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}],null]},[["$","html",null,{"lang":"zh","children":[["$","link",null,{"rel":"icon","href":"/favicon.png?<generated>","type":"image/<generated>","sizes":"<generated>"}],["$","$L6",null,{"src":"https://www.googletagmanager.com/gtag/js?id=G-N3DJ3JTVT2"}],["$","$L6",null,{"id":"google-analytics","children":"\n          window.dataLayer = window.dataLayer || [];\n          function gtag(){dataLayer.push(arguments);}\n          gtag('js', new Date());\n        \n          gtag('config', 'G-N3DJ3JTVT2');\n        "}],["$","body",null,{"className":"__className_36bd41","children":[["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"styles":null}],["$","$L7",null,{}]]}]]}],null],null],[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/aae87c042353adfd.css","precedence":"next","crossOrigin":"$undefined"}]],[null,"$L8"]]]]]
9:I[2612,["577","static/chunks/221e729c-e5a67d23aac7644c.js","231","static/chunks/9316e0b3-81def07e0919db1c.js","974","static/chunks/974-9ffea8f9ea4bfaa2.js","536","static/chunks/536-12c341f043d96047.js","665","static/chunks/665-f7c57b2084cbed6b.js","241","static/chunks/app/article/%5Bid%5D/page-28a3798f9eb189fc.js"],"default"]
a:I[4306,["577","static/chunks/221e729c-e5a67d23aac7644c.js","231","static/chunks/9316e0b3-81def07e0919db1c.js","974","static/chunks/974-9ffea8f9ea4bfaa2.js","536","static/chunks/536-12c341f043d96047.js","665","static/chunks/665-f7c57b2084cbed6b.js","241","static/chunks/app/article/%5Bid%5D/page-28a3798f9eb189fc.js"],"default"]
b:I[231,["577","static/chunks/221e729c-e5a67d23aac7644c.js","231","static/chunks/9316e0b3-81def07e0919db1c.js","974","static/chunks/974-9ffea8f9ea4bfaa2.js","536","static/chunks/536-12c341f043d96047.js","665","static/chunks/665-f7c57b2084cbed6b.js","241","static/chunks/app/article/%5Bid%5D/page-28a3798f9eb189fc.js"],""]
c:I[4254,["577","static/chunks/221e729c-e5a67d23aac7644c.js","231","static/chunks/9316e0b3-81def07e0919db1c.js","974","static/chunks/974-9ffea8f9ea4bfaa2.js","536","static/chunks/536-12c341f043d96047.js","665","static/chunks/665-f7c57b2084cbed6b.js","241","static/chunks/app/article/%5Bid%5D/page-28a3798f9eb189fc.js"],"default"]
e:I[3869,["577","static/chunks/221e729c-e5a67d23aac7644c.js","231","static/chunks/9316e0b3-81def07e0919db1c.js","974","static/chunks/974-9ffea8f9ea4bfaa2.js","536","static/chunks/536-12c341f043d96047.js","665","static/chunks/665-f7c57b2084cbed6b.js","241","static/chunks/app/article/%5Bid%5D/page-28a3798f9eb189fc.js"],"default"]
f:I[5339,["577","static/chunks/221e729c-e5a67d23aac7644c.js","231","static/chunks/9316e0b3-81def07e0919db1c.js","974","static/chunks/974-9ffea8f9ea4bfaa2.js","536","static/chunks/536-12c341f043d96047.js","665","static/chunks/665-f7c57b2084cbed6b.js","241","static/chunks/app/article/%5Bid%5D/page-28a3798f9eb189fc.js"],"Waline"]
10:I[8360,["577","static/chunks/221e729c-e5a67d23aac7644c.js","231","static/chunks/9316e0b3-81def07e0919db1c.js","974","static/chunks/974-9ffea8f9ea4bfaa2.js","536","static/chunks/536-12c341f043d96047.js","665","static/chunks/665-f7c57b2084cbed6b.js","241","static/chunks/app/article/%5Bid%5D/page-28a3798f9eb189fc.js"],"default"]
11:I[4226,["577","static/chunks/221e729c-e5a67d23aac7644c.js","231","static/chunks/9316e0b3-81def07e0919db1c.js","974","static/chunks/974-9ffea8f9ea4bfaa2.js","536","static/chunks/536-12c341f043d96047.js","665","static/chunks/665-f7c57b2084cbed6b.js","241","static/chunks/app/article/%5Bid%5D/page-28a3798f9eb189fc.js"],"default"]
d:T1d21,
    <p class="time">发布时间：<time datetime="27 November, 2022">2022-11-27 16:28:46</time></p>
    <p class="words">本文字数：1,080 字       阅读完需：约 3 分钟</p>
    <h2>前言</h2>
<p>很早就想配置一个自己的邮件服务器，苦于没有时间。偶然的机会，黑色星期五买了一台1G内存的特价服务器，开放了25端口，于是趁这个周末，决定搭建一个自己的域名邮箱。</p>
<p>技术选型: docker-mailserver</p>
<p>优势:</p>
<ol>
<li>
<p>简单/方便。你要知道自己去手动配一台这样功能完全的邮件服务器，也许一个晚上的时间都不够，稍微一个地方出错还可能用不了。</p>
</li>
<li>
<p>安全，你要知道邮件服务器，自用问题不大，如果是公共服务，各种SPAM/病毒邮件，你就会发现原来邮件服务器是真的难伺候。</p>
</li>
<li>
<p>也就是我个人觉得最重要的原因。我自建一个邮件服务器，是出于自用的目的，我拿一台VPS出来就只装一个邮件服务，我真的觉得太浪费。所以像这样用Docker，在部署完了后，我还可以装点别的程序跑一跑。而我之前介绍的Mailcow/Mailu/Poste.io这些，虽然它们都是用Docker部署的，但是都把80/443占用了，我们最多也就只能再跑一些小脚本，如果我们还想建站呢？那这些方案就不适合我们。</p>
</li>
</ol>
<h2>搭建步骤</h2>
<h3>配置DNS</h3>
<p>首先需要在主机商配置反向dns解析</p>
<p>之后前往域名提供商进行dns解析设置</p>
<p>|类型|记录名|记录值|
|--|--|--|
|A|mail|xxx.xxx.xxx.xxx(自己服务器的ip)|
|MX|@|mail.example.com(mail.&#x3C;域名>); 优先级选10|
|TXT|@|v=spf1 mx ~all|</p>
<h3>使用certbot申请https证书</h3>
<p>安装好管理工具之后, 我们需要申请证书下来, 这里我的web服务器是NGINX, 并且我没有网站的静态目录, 所以我使用这个命令申请:</p>
<pre><code class="language-bash">sudo certbot certonly --standalone -d example.com -d www.example.com -d m.example.com
</code></pre>
<p>如果你的网站有静态目录的话, 可以把<code>--standalone</code>改成<code>--webroot</code>并且加上<code>-w</code>参数申请, 类似这样:</p>
<pre><code class="language-bash">sudo certbot certonly --webroot -w /var/www/html -d example.com -d www.example.com
</code></pre>
<p>在你使用<code>--standalone</code>申请证书的时候需要关闭nginx, 因为certbot会启用443端口校验你的域名信息, 如果nginx没有关闭, 会导致端口占用, 所以我们关闭nginx, 我这里是使用ubuntu, 所以使用这个命令关闭nginx:</p>
<pre><code class="language-bash">sudo services nginx stop
</code></pre>
<p>更新证书时使用<code>certbot renew</code>命令即可</p>
<p>使用<code>crontab</code>添加定时任务</p>
<p>可使用crontab配置证书自动续签</p>
<pre><code class="language-bash">crontab -e
# 添加如下
0 3 1 * * /usr/bin/certbot renew --quiet
</code></pre>
<ul>
<li><code>0 3 1 * *</code> 指每个月1号3点0分执行任务</li>
</ul>
<h3>解析验证</h3>
<p>使用dig验证解析是否生效</p>
<pre><code class="language-bash">apt-get install dnsutils
dig TXT _acme-challenge.mail.example.com
</code></pre>
<h3>安装docker</h3>
<p>基于debian11系统进行，参考官方文档 <a href="https://docs.docker.com/engine/install/debian/">https://docs.docker.com/engine/install/debian/</a></p>
<pre><code class="language-bash"># 移除之前的版本
sudo apt-get remove docker docker-engine docker.io containerd runc 
# 安装依赖
sudo apt-get update
sudo apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
# 配置apt源
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
# 安装
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
</code></pre>
<h3>修改docker存储目录(可选)</h3>
<p>查看原始存储目录</p>
<pre><code class="language-bash">docker info
</code></pre>
<p>可以发现<code>Docker Root</code>项默认目录为<code>/var/lib/docker</code></p>
<pre><code class="language-bash">cd /etc/docker/
vim daemon.json
</code></pre>
<p>添加以下内容</p>
<pre><code class="language-json">{
        "data-root": "/data/docker"
}
</code></pre>
<p>保存退出，然后重启 docker 服务：</p>
<pre><code class="language-bash">systemctl restart docker
docker info # 查看是否修改成功
</code></pre>
<h3>拉取配置文件</h3>
<pre><code class="language-bash">git clone https://github.com/docker-mailserver/docker-mailserver.git
# 所需文件
- docker-compose.yml 容器部署文件
- setup.sh 服务配置脚本
</code></pre>
<p>如果后续读取配置报错，需要在<code>docker-compose.yml</code>头部添加 <code>version: '3'</code> ，以配置版本</p>
<h3>开放端口</h3>
<p>需要开放[25,193,993,465,587]这几个端口，以下以ufw举例，具体开放防火墙请自行Google</p>
<pre><code class="language-bash">ufw allow 25
ufw allow 143
ufw allow 993
ufw allow 465
ufw allow 587
</code></pre>
<h3>生成DKIM签名记录</h3>
<pre><code class="language-bash">./setup.sh config dkim keysize 2048
cd ~/docker-mailserver/docker-data/dms/
cat config/opendkim/keys/example.com/mail.txt
# 截取格式如下
v=DKIM1;h=sha256;k=rsa;p=xxx
</code></pre>
<p>添加到dns解析当中</p>
<p>|类型|记录名|记录值|
|--|--|--|
|TXT|mail._domainkey|v=DKIM1;h=sha256;k=rsa;p=xxx</p>
<h3>配置tls</h3>
<p>编辑docker-mailserver配置文件</p>
<pre><code class="language-bash">cd docker-mailserver
vim .env
</code></pre>
<p>编辑 -volumes配置项下添加 <code>- /etc/letsencrypt/:/etc/letsencrypt:ro</code></p>
<p>编辑<code>mailserver.env</code>文件</p>
<pre><code class="language-env">SSL_TYPE=letsencrypt
SSL_CERT_PATH=/etc/letsencrypt/live/mail.timeshike.com/fullchain.pem
SSL_KEY_PATH=/etc/letsencrypt/live/mail.timeshike.com/privkey.pem
</code></pre>
<p>最后重启docker-mailserver即可：</p>
<pre><code class="language-bash">docker-compose stop
systemctl restart docker.service
docker-compose up -d
docker-compose logs -f # 查看容器日志
</code></pre>
<p>安装完成!</p>
<h2>邮箱服务器管理</h2>
<p>利用<code>setup.sh</code>脚本可以轻松实现管理账户</p>
<p>可参考官方文档 <a href="https://docker-mailserver.github.io/docker-mailserver/edge/config/setup.sh/">https://docker-mailserver.github.io/docker-mailserver/edge/config/setup.sh/</a></p>
<pre><code class="language-bash">./setup.sh email add admin@example.com "xxx" # 添加账号密码
# 其他功能参见help
./setup.sh help
</code></pre>
<h2>参考文章</h2>
<p>本文参考了以下博文，感谢作者的付出</p>
<ol>
<li><a href="https://blog.cetacean.top/mailserver/">https://blog.cetacean.top/mailserver/</a></li>
<li><a href="https://lala.im/4224.html">https://lala.im/4224.html</a></li>
<li><a href="https://docker-mailserver.github.io/docker-mailserver/edge/">https://docker-mailserver.github.io/docker-mailserver/edge/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/95533274">https://zhuanlan.zhihu.com/p/95533274</a></li>
</ol>

  2:["$","div",null,{"className":"article_pageBody__Bryg4","children":[["$","$L9",null,{"menuItemList":[{"id":0,"label":"首页","href":"/","icon":"/icons/home_gray.svg","iconSelected":"/icons/home_black.svg"},{"id":1,"label":"文章","href":"/articles/all/1","icon":"/icons/article_gray.svg","iconSelected":"/icons/article_black.svg"},{"id":3,"label":"关于","href":"/about","icon":"/icons/about_gray.svg","iconSelected":"/icons/about_black.svg"},{"id":4,"label":"搜索","href":"/search","icon":"/icons/search_gray.svg","iconSelected":"/icons/search_black.svg"}],"currentSelectedLabel":"文章"}],["$","div",null,{"className":"article_pageBodyMain___x_AF","children":[["$","$La",null,{}],["$","div",null,{"className":"article_articleContainer__uRwUh scrollContent","children":[["$","div",null,{"className":"article_articleBody__0coIY scrollContent","children":[["$","h1",null,{"style":{"marginBottom":"0.1rem","marginTop":"0.2rem"},"children":"基于docker的轻量级邮件服务器的搭建和使用教程"}],["$","div",null,{"children":[["$","div",null,{"className":"tags_tags__qM_Ja","children":[["$","p",null,{"className":"tags_label__Rg6b2","children":"分类"}],[["$","$Lb","0",{"href":"/articles/建站技术/1","children":["$","p","0",{"className":"tags_tag__HZYxk tags_tagLink__gnw9V","children":"建站技术"}]}]],false]}],["$","div",null,{"className":"tags_tags__qM_Ja","children":[["$","p",null,{"className":"tags_label__Rg6b2","children":"标签"}],"$undefined",[["$","p","0",{"className":"tags_tag__HZYxk ","children":"linux"}],["$","p","1",{"className":"tags_tag__HZYxk ","children":"docker"}],["$","p","2",{"className":"tags_tag__HZYxk ","children":"mail"}],["$","p","3",{"className":"tags_tag__HZYxk ","children":"server"}],["$","p","4",{"className":"tags_tag__HZYxk ","children":"教程"}]]]}],["$","$Lc",null,{"path":"linux%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%90%AD%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B","serverURL":"https://remark.timeshike.com/"}]]}],["$","article",null,{"dangerouslySetInnerHTML":{"__html":"$d"}}],["$","$Le",null,{}],["$","$Lf",null,{"path":"linux%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%90%AD%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B","serverURL":"https://remark.timeshike.com/","lang":"zh-CN"}],["$","div",null,{"className":"bottomBar_bottomBar__uHU1W","children":["$","div",null,{"className":"bottomBar_text__iz3cM","children":["Powerd by",["$","a",null,{"href":"https://github.com/hixyl/YlBlog","target":"_blank","children":" YlBlog(玉龙博客)"}]]}]}]]}],["$","$L10",null,{}]]}]]}],["$","$L11",null,{}]]}]
8:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"基于docker的轻量级邮件服务器的搭建和使用教程 - 流年石刻"}],["$","meta","3",{"name":"next-size-adjust"}]]
1:null
